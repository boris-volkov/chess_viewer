name: Release (Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone vcpkg
        shell: pwsh
        run: git clone https://github.com/microsoft/vcpkg "${{ env.VCPKG_ROOT }}"

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          & "${{ env.VCPKG_ROOT }}/bootstrap-vcpkg.bat"

      - name: Install dependencies
        shell: pwsh
        run: |
          & "${{ env.VCPKG_ROOT }}/vcpkg.exe" install sdl2 sdl2-image --triplet x64-windows

      - name: Configure
        shell: pwsh
        run: cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake" -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: pwsh
        run: cmake --build build --config Release

      - name: Bundle runtime DLLs
        shell: pwsh
        run: |
          $vcpkgRoot = "${{ env.VCPKG_ROOT }}"
          $exe = "build\Release\chess_viewer.exe"
          if (!(Test-Path $exe)) { $exe = "build\chess_viewer.exe" }
          & "$vcpkgRoot/scripts/buildsystems/msbuild/applocal.ps1" -targetBinary $exe -installedDir "$vcpkgRoot/installed/x64-windows/bin"

      - name: Package zip
        shell: pwsh
        run: |
          $exe = "build\Release\chess_viewer.exe"
          $exeDir = "build\Release"
          if (!(Test-Path $exe)) {
            $exe = "build\chess_viewer.exe"
            $exeDir = "build"
          }
          $dist = "dist\chess_viewer"
          New-Item -ItemType Directory -Force $dist | Out-Null
          Copy-Item $exe $dist -Force
          Copy-Item "$exeDir\*.dll" $dist -Force
          Copy-Item "games" $dist -Recurse -Force
          Copy-Item "pieces" $dist -Recurse -Force
          Copy-Item "README.md","LICENSE" $dist -Force
          Compress-Archive -Path "$dist\*" -DestinationPath "chess_viewer-win64.zip" -Force

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: chess_viewer-win64.zip
